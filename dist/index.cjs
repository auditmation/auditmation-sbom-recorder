"use strict";var N=Object.create;var E=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var D=(e,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of v(t))!O.call(e,i)&&i!==n&&E(e,i,{get:()=>t[i],enumerable:!(a=C(t,i))||a.enumerable});return e};var w=(e,t,n)=>(n=e!=null?N(J(e)):{},D(t||!e||!e.__esModule?E(n,"default",{value:e,enumerable:!0}):n,e));var g=w(require("@actions/core"),1),S=w(require("@actions/exec"),1),x=require("@auditmation/util-logger"),F=require("@auditmation/module-auditmation-auditmation-file-service"),l=require("@zerobias-com/platform-sdk"),m=require("@zerobias-org/types-core-js"),b=require("@auditmation/types-core-js"),$=w(require("axios"),1),y=w(require("node:fs"),1),U=w(require("md5-file"),1),k=w(require("node:path"),1),R=w(require("node:https"),1),o=(0,x.getLogger)("console",{},process.env.LOG_LEVEL||"debug"),L="209010da-70d1-5fa5-babf-91974fa13bd2",B="Auditmation SBOM Recorder";process.on("unhandledRejection",(e,t)=>{o.error("Unhandled Rejection at Promise:",t),o.error("Reason:",e)});process.on("uncaughtException",e=>{o.error("Uncaught Exception thrown:",e),process.exit(1)});async function j(){let e=g.getInput("product-id"),t=g.getInput("package"),n=t.indexOf("@",1);if(n===-1)throw new Error("Invalid package format. Expected @scope/package@version");let a=t.slice(n+1),i=t.slice(0,n),s=g.getInput("file-path"),c=g.getInput("api-key"),d=g.getInput("org-id"),r=g.getInput("url"),p=await m.URL.parse(r),h=p.hostname.startsWith("api")?p.hostname:`api.${p.hostname}`;p=await m.URL.parse(`${p.protocol}://${h}`);let u=g.getInput("boundary-id");return{productId:e,packageName:i,version:a,filePath:s,apiKey:c,orgId:d,url:p,boundaryId:u}}async function z(e){let{packageName:t,version:n,filePath:a}=e,i="";await S.exec("npm",["--silent","pack",`${t}@${n}`],{listeners:{stdout:f=>{i+=f.toString()}},cwd:process.cwd()}),i=i.trim(),await S.exec("sh",["-c",`tar zxf ${i}`]);let s="";await S.exec("pwd",[],{listeners:{stdout:f=>{s+=f.toString()}}});let d=s.trim(),r=k.default.join(d,"package",a),p=n;if(p==="latest"){let f=k.default.join(d,"package","package.json"),P=y.readFileSync(f);p=JSON.parse(P.toString("utf8")).version}if(!y.existsSync(r))throw new Error(`SBOM file not found: ${r}`);let h=y.statSync(r),u=U.default.sync(r);return{pkgName:t,version:p,sbomFilePath:r,fileSize:h.size,checksum:u}}async function M(e){let{url:t,apiKey:n,orgId:a}=e,i=$.default.create({baseURL:t.toString(),headers:{Authorization:`APIKey ${n}`,"dana-org-id":a.toString()}}),s=(0,F.newFileService)();await s.connect({apiKey:n,orgId:await b.UUID.parse(a),url:await b.URL.parse(`${t.toString()}file-service`)});let c=(0,l.newPlatformApi)();await c.connect({apiKey:n,orgId:await m.UUID.parse(a),url:`${t.toString()}platform`}),c.enableRequestInspection(!0);let d=c.getRequestInspector();return d.onRequest(r=>{o.debug(`
\u2192 SDK REQUEST: ${r.method?.toUpperCase()} ${r.url}`),o.debug("  Headers:",JSON.stringify(r.headers,null,2)),r.data&&o.debug("  Body:",typeof r.data=="string"?r.data:JSON.stringify(r.data,null,2))}),d.onResponse(r=>{o.debug(`
\u2190 SDK RESPONSE: ${r.status} ${r.statusText}`),o.debug(`  Duration: ${r.duration}ms`),r.data&&o.debug("  Response data:",typeof r.data=="string"?r.data:JSON.stringify(r.data,null,2))}),{axios:i,fileService:s,platform:c}}async function V(e,t){let{platform:n}=e,{boundaryId:a}=t;return a||(a=(await n.getBoundaryApi().listBoundaries()).items[0].id),o.info("Using boundary:",a),a}async function K(e,t,n){let{platform:a}=e;o.info("Creating boundary product..."),o.info("  boundaryId:",t),o.info("  productId:",n);try{let s={name:"Auditmation",description:"",productIds:[await m.UUID.parse(n)]};o.info("  createBoundaryProduct payload:",JSON.stringify(s));let c=await m.UUID.parse(t);await a.getBoundaryApi().createBoundaryProduct(c,s),o.info("Boundary product created successfully")}catch(i){o.info("Boundary product creation failed (may already exist)"),o.info("  Error message:",i.message),i.response&&(o.info("  Response status:",i.response.status),o.info("  Response data:",JSON.stringify(i.response.data)));let s=i.response?.data?.message||i.message||"";if(!s.includes("already exists")&&!s.includes("duplicate")){let c=new Error(`Failed to create boundary product in ensureBoundaryProduct(): ${i.message}`);throw c.stack=`${c.stack}
Caused by: ${i.stack}`,c}}o.info("Listing boundary products...");try{let i=await m.UUID.parse(t),c=(await a.getBoundaryApi().listBoundaryProductsByBoundary(i)).items.find(d=>d.productId.toString()===n);if(!c)throw new Error(`Boundary product not found for product ID: ${n}`);return o.info("Boundary product:",c.id),c.id}catch(i){let s=i,c=new Error(`Failed in listBoundaryProductsByBoundary(): ${s.message}`);throw c.stack=`${c.stack}
Caused by: ${s.stack}`,c}}async function T(e,t,n,a,i){let{platform:s}=e,c=i.pkgName.replace("@","").replace("/","-");o.info("Checking for existing pipeline...");try{o.info("  Searching for pipeline with name:",B);let d=await s.getPipelineApi().list(),r;if(d.items.length===0){o.info("Creating new pipeline...");let p={name:B,productId:a,boundaryId:t,boundaryProductId:n,description:`Auto generated pipeline from ${c} SBOMs`,timezone:m.TimeZone.Utc,targets:{},moduleName:"Auditmation",format:l.PipelineFormatEnum.File,executionMode:l.PipelineExecutionModeEnum.Receiver,connectorType:l.PipelineConnectorTypeEnum.ProductSpecific};o.info("  Pipeline payload:",JSON.stringify(p,null,2)),r=await s.getPipelineApi().create(p),o.info("Pipeline created successfully")}else o.info("Using existing pipeline"),[r]=d.items;return r.adminStatus===l.PipelineAdminStatusEnum.Draft?(o.info("Updating pipeline status from draft to created..."),r.adminStatus=l.PipelineAdminStatusEnum.Created,r=await s.getPipelineApi().update(r.id,r)):o.info(`Pipeline already in ${r.adminStatus} status, skipping status update`),o.info("Using pipeline:",r.id),r}catch(d){let r=d,p=new Error(`Failed in ensurePipeline(): ${r.message}`);throw p.stack=`${p.stack}
Caused by: ${r.stack}`,p}}async function q(e,t){let{platform:n}=e,a=await n.getPipelineJobApi().createPipelineJob({pipelineId:t,previewMode:!1});return o.info("Created job:",a.id),a}async function _(e,t,n){let{platform:a}=e,i=await a.getBatchApi().createBatch({className:"EvidenceFile",jobId:t,groupId:n});return o.info("Created batch:",i.id),i}async function G(e,t){let n=await e.getResourceApi().searchResources(void 0,void 0,["pipeline"],void 0,["folder"]),a=n.items?.find(s=>s.name==="pipeline")?.id;a||(a=(await e.getFolderApi().create({name:"pipeline"})).id),n=await e.getResourceApi().searchResources(void 0,void 0,[t.toString()],void 0,["folder"]);let i=n.items?.find(s=>s.name===t.toString())?.id;return i||(i=(await e.getFolderApi().create({name:t.toString(),folderId:a.toString()})).id),i}async function H(e,t,n,a,i,s,c){return new Promise((d,r)=>{let p=y.createReadStream(i),h={hostname:e.hostname,port:e.port,path:`/file-service/files/${a}/upload?checksum=${c}`,method:"POST",protocol:"https:",headers:{"content-length":s.toString(),"content-type":"application/json",Authorization:`APIKey ${t}`,"dana-org-id":n.toString()}},u="",f=R.request(h,P=>{P.on("data",I=>{let A=I.toString();o.info("Upload chunk received:",A),u+=A}),P.on("end",()=>{o.info("File upload completed");try{let I=JSON.parse(u);d(I.fileVersionId)}catch{r(new Error(`Failed to parse upload response: ${u}`))}})});f.on("error",P=>{o.error(`Error uploading file: ${P.message}`),r(P)}),p.pipe(f)})}async function Q(e,t,n,a){let{fileService:i}=e,{sbomFilePath:s,pkgName:c,version:d,fileSize:r,checksum:p}=n,h=await G(i,t),u=await i.getFileApi().create({name:`${c}-${d}.json`,description:`SBOM for ${c}`,folderId:h,retentionPolicy:{},syncPolicy:{}});o.info("File:",u.id),o.info("File object:",JSON.stringify(u,null,2));let f=u.fileVersionId?.toString()||"";return p===u.checksum?o.info("File checksum matches, skipping upload"):(f=await H(a.url,a.apiKey,a.orgId,u.id,s,r,p),o.info("File uploaded with new version:",f)),{...u,fileVersionId:f}}async function W(e,t,n,a,i){let{platform:s}=e,c={payload:{id:n.id,name:n.name,fileVersionId:n.fileVersionId,size:i,mimeType:"application/json",evidenceDefinition:L,pipelineId:a},rawData:{}};o.info("Adding batch item with payload:",JSON.stringify(c,null,2));let d=await s.getBatchApi().addBatchItem(t,c);o.info("Batch item:",d.id)}async function Z(e,t){let{platform:n}=e;await n.getPipelineJobApi().updatePipelineJob(t,{status:l.PipelineJobStatusEnum.Completed})}async function X(e,t){let{platform:n}=e;await n.getBatchApi().endBatch(t)}async function Y(){try{let e=await j(),t=await z(e),n=await M(e),a=await V(n,e),i=await K(n,a,e.productId),s=await T(n,a,i,e.productId,t),c=await q(n,s.id),d=await _(n,c.id,t.pkgName),r=await Q(n,s.id,t,e);await W(n,d.id,r,s.id,t.fileSize),await Z(n,c.id),await X(n,d.id),o.info("SBOM upload completed successfully")}catch(e){let t=e;o.error("Error:",t.message),o.error("Stack:",t.stack),g.setFailed(t.message),process.exit(1)}}Y().catch(e=>{o.error("Unhandled error in run():",e),process.exit(1)});
//# sourceMappingURL=index.cjs.map
